<html>
<head>
<link href="image-picker.css" rel="stylesheet">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="image-picker.min.js"></script>
<script type="text/javascript" src="node_modules/tracking/build/tracking-min.js"></script>
<script src="node_modules/dat.gui/build/dat.gui.min.js"></script>

<script src="stats.min.js"></script>
  <script src="color_camera_gui.js"></script>

<script type="text/javascript">
//globals
  
var gridSpacing = 46.75;
var context;
var showLines = false;

var m, b, deltaX, deltaY, wall, wallX, wallY, wallB, iData;
    
var iPhoneScreenWidth = 416 * 1.5;
var iPhoneScreenHeight = 738 * 1.5;

var rightWall = (391 / 416) * iPhoneScreenWidth;
var leftWall = (30 / 416) * iPhoneScreenWidth;
        
var rotationPointX = (208 / 416) * iPhoneScreenWidth;
var rotationPointY = (610 / 738) * iPhoneScreenHeight; 

</script>

<script src="models/Bubble.js"></script>
<script src="models/Grid.js"></script>
<script src="models/TouchPoint.js"></script>

<script src="helpers/math.js"></script>
<script src="helpers/imageRecognition.js"></script>

<style>
  body {
    background: white;
    display: -webkit-flex;
    -webkit-justify-content: center;
    -webkit-align-items: center;
    -webkit-flex-direction: column;
  }
  video {
    width: 414px;
    height: 736px;
/*
    width: 1080px;
    height: 1920px;
*/
    background: rgba(0,0,0,0.25);
  }
  button {
    display: inline-block;
    background: -webkit-linear-gradient(#F9F9F9 40%, #E3E3E3 70%);
    background: linear-gradient(#F9F9F9 40%, #E3E3E3 70%);
    border: 1px solid #999;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    padding: 5px 8px;
    outline: none;
    white-space: nowrap;
    -webkit-user-select: none;
    user-select: none;
    cursor: pointer;
    text-shadow: 1px 1px #fff;
    font-weight: 700;
    font-size: 10pt;
  }
  button:hover,
  button.active {
    border-color: black;
  }
  button:active,
  button.active {
    background: -webkit-linear-gradient(#E3E3E3 40%, #F9F9F9 70%);
    background: linear-gradient(#E3E3E3 40%, #F9F9F9 70%);
  }

  video {
    background: white url(desktop.png) center no-repeat;
    border: 1px solid #e2e2e2;
    box-shadow: 0 1px 1px rgba(0,0,0,0.2);
  }
  
  #output-container {
      position: relative;
  }
  
  #grid, .grid-new-piece {
      position: absolute;
        top: 80px;
        left: 24px;
    }

    #grid-new-piece-1 {
        top: 455px;
        left: 10px;
    }
    
    #grid-new-piece-2 {
        top: 455px;
        left: 110px;
    }
    
    #grid-new-piece-3 {
        top: 455px;
        left: 230px;
    }
  
  #grid table td {
        width: 33px;
        height: 35px;
/*       background: rgba(255,0,0,.5); */
  }
  
/*
  #grid table td.empty {
      background: rgba(0,0,0,.5);
  }
  */
  #grid table td.placement {
      background: green;
  }

  
  
  .grid-new-piece table td {
        width: 18px;
        height: 19px;
      background: rgba(255,0,0,.5);
  }
  
  .grid-new-piece table td.empty {
      background: rgba(0,0,0,.5);
  }
  
    video, canvas {
    position: absolute;
  }
  
  #output-container {
      display: none;
  }
  
</style>
</head>
<body>
  <select id="picture" class="image-picker show-html">
  </select>
  <video id="iphone-screen-stream" autoplay></video>
  
  <canvas id="canvas" width="416" height="738"></canvas>
  
  <p><button id="enable-capture">Enable Capture</button></p>
  
  
<button onclick="shoot()" style="width: 64px;border: solid 2px #ccc;">Capture</button>
  
  <div id="output-container">
      <div id="output" style="display: inline-block; top: 4px; position: relative ;border: dotted 1px #ccc; padding: 2px;"><img src="demos/1.png"></div>
      <div id="grid"></div>
      <div class="grid-new-piece" id="grid-new-piece-1"></div>
      <div class="grid-new-piece" id="grid-new-piece-2"></div>
      <div class="grid-new-piece" id="grid-new-piece-3"></div>
  </div>
  
  
<script src="app.js"></script>

  <script>
      
    var grid = new Grid;
          
    window.onload = function() {
                        
        document.getElementById('iphone-screen-stream').setAttribute("style", "width: " + iPhoneScreenWidth + "px; height: " + iPhoneScreenHeight + "px;");
        document.getElementById('canvas').setAttribute("width", iPhoneScreenWidth);
        document.getElementById('canvas').setAttribute("height", iPhoneScreenHeight);
        
      var canvas = document.getElementById('canvas');
      context = canvas.getContext('2d');
      
      var video = document.getElementById('iphone-screen-stream');      
      
      context.strokeStyle = "#00901b";
      context.fillStyle = "#fff";
      context.font = '11px Helvetica';
      
      tracking.ColorTracker.registerColor('darkgrey1', function(r, g, b) {
        var dx = r - 55;
        var dy = g - 46;
        var dz = b - 56;
        if ((b - g) >= 100 && (r - g) >= 60) {
          return true;
        }
        return dx * dx + dy * dy + dz * dz < 3500;
      });
      
      tracking.ColorTracker.registerColor('darkgrey2', function(r, g, b) {
        var dx = r - 50;
        var dy = g - 44;
        var dz = b - 61;
        if ((b - g) >= 100 && (r - g) >= 60) {
          return true;
        }
        return dx * dx + dy * dy + dz * dz < 3500;
      });
      
      tracking.ColorTracker.registerColor('greenbubble', function(r, g, b) {
        var dx = r - 38;
        var dy = g - 173;
        var dz = b - 0;
        if ((b - g) >= 100 && (r - g) >= 60) {
          return true;
        }
        return dx * dx + dy * dy + dz * dz < 3500;
      });
            
      var tracker = new tracking.ColorTracker(['darkgrey1','darkgrey2','greenbubble']);
      tracker.setMinDimension((5 / 416) * iPhoneScreenWidth);
      tracker.setMaxDimension((30 / 416) * iPhoneScreenWidth);
      tracking.track('#iphone-screen-stream', tracker);
      tracker.on('track', function(event) {
          
          
           var w = iPhoneScreenWidth;
                    var h = iPhoneScreenHeight;
                    var videoCanvas = document.createElement('canvas');
                        videoCanvas.width  = w;
                        videoCanvas.height = h;
          
          var videoContext = videoCanvas.getContext('2d');
                    videoContext.drawImage(video, 0, 0, w, h);
                    
        context.clearRect(0, 0, canvas.width, canvas.height);
        
        iData = videoContext.getImageData(rotationPointX, rotationPointY, 1, 1);
        
        var onDeckOffset = 74;
        
        var onDeckData = videoContext.getImageData(rotationPointX, rotationPointY + onDeckOffset, 1, 1);
        
        var shooterBallColor = getBubbleColor(iData);
        var onDeckBallColor = getBubbleColor(onDeckData);
        
        var centerX = rotationPointX;
        var centerY = rotationPointY;
        
        var radius = gridSpacing / 2;
        
        context.beginPath();
        context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
     //   context.fillStyle = 'red';
       // context.fill();
        context.lineWidth = 1;
        context.strokeStyle = '#003300';
        context.stroke();
        
        if(shooterBallColor === "purple") {
            context.fillStyle = 'purple';
            context.fill();
        } else if(shooterBallColor === "green") {
            context.fillStyle = 'green';
            context.fill();
        } else if(shooterBallColor === "orange") {
            context.fillStyle = 'orange';
            context.fill();
        } else if(shooterBallColor === "lightblue") {
            context.fillStyle = '#34a5f2';
            context.fill();
        } else if(shooterBallColor === "blue") {
            context.fillStyle = 'blue';
            context.fill();
        } else if(shooterBallColor === "red") {
            context.fillStyle = 'red';
            context.fill();
        } else {
            context.fillStyle = 'transparent';
        }
        
        context.beginPath();
        context.arc(centerX, centerY + onDeckOffset, radius, 0, 2 * Math.PI, false);
     //   context.fillStyle = 'red';
       // context.fill();
        context.lineWidth = 1;
        context.strokeStyle = '#003300';
        context.stroke();
        
        if(onDeckBallColor === "purple") {
            context.fillStyle = 'purple';
            context.fill();
        } else if(onDeckBallColor === "green") {
            context.fillStyle = 'green';
            context.fill();
        } else if(onDeckBallColor === "orange") {
            context.fillStyle = 'orange';
            context.fill();
        } else if(onDeckBallColor === "lightblue") {
            context.fillStyle = '#34a5f2';
            context.fill();
        } else if(onDeckBallColor === "blue") {
            context.fillStyle = 'blue';
            context.fill();
        } else if(onDeckBallColor === "red") {
            context.fillStyle = 'red';
            context.fill();
        } else {
            context.fillStyle = 'transparent';
        }
            
        if(getBubbleColor(iData)) {
            grid.resetGrid();
            for(var j = 0 ; j < 15 ; j++) {
                if(grid.lastRow() == j - 1) //only check until rows are empty
                for(var i = 0 ; i < 11 ; i++) {
                    
                    var centerX = 68 + i * gridSpacing;
                    var centerY = 204 + j * gridSpacing;
                    
                    if(j % 2 === 1)
                        centerX += gridSpacing / 2;
                    
                    var radius = gridSpacing / 2;
                    
                    context.beginPath();
                    context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
                 //   context.fillStyle = 'red';
                   // context.fill();
                    context.lineWidth = 1;
                    context.strokeStyle = '#003300';
                    context.stroke();
                    
                 //   if(i == 2 && j == 0) {
                    
                
                        iData = videoContext.getImageData(centerX, centerY, 1, 1);
                        
                        var bubbleColor = getBubbleColor(iData);
                        
                        if(bubbleColor === "purple") {
                            context.fillStyle = 'purple';
                            context.fill();
                            grid.add(i,j,'purple');
                        } else if(bubbleColor === "green") {
                            context.fillStyle = 'green';
                            context.fill();
                            grid.add(i,j,'green');
                        } else if(bubbleColor === "orange") {
                            context.fillStyle = 'orange';
                            context.fill();
                            grid.add(i,j,'orange');
                        } else if(bubbleColor === "lightblue") {
                            context.fillStyle = '#34a5f2';
                            context.fill();
                            grid.add(i,j,'lightblue');
                        } else if(bubbleColor === "blue") {
                            context.fillStyle = 'blue';
                            context.fill();
                            grid.add(i,j,'blue');
                        } else if(bubbleColor === "red") {
                            context.fillStyle = 'red';
                            context.fill();
                            grid.add(i,j,'red');
                        } else {
                            context.fillStyle = 'transparent';
                            grid.add(i,j,0);
                        }
                        
                   //     var possibleShots = grid.getPossibleShots('r');
                      //  if()
                                            
              //      tracker.stop();
                    
                //    }
                    
                }
                
            }
                        
            var availableShots = grid.availableShots();
            
            var intersectionCounter = 1;
            for(var i = 0 ; i < availableShots.length ; i++) {
                
                var shot = availableShots[i];
                
                context.beginPath();
                context.arc(shot.getCenterX(), shot.getCenterY(), radius, 0, 2 * Math.PI, false);
                context.fillStyle = 'rgba(0,0,0,.5)';
                
                context.fill();
                context.lineWidth = 1;
                context.strokeStyle = '#003300';
                context.stroke();
                
                context.fillStyle = "white";
                context.textAlign = "center";
                context.fillText(intersectionCounter++, shot.getCenterX(), shot.getCenterY()); 
            }           
            
        }
        
        //draw theoritical lines
        
        if(showLines) {
            context.strokeStyle = "#ff0096";
            
            var lineCounter = 0;
            for(var i = 100 ; i < rotationPointY ; i+=20) {
                
                context.beginPath();
                context.moveTo(leftWall, i);
                context.lineTo(rotationPointX,rotationPointY);
                context.closePath();
                context.stroke();
                lineCounter++;
                
                context.beginPath();
                context.moveTo(rightWall, i);
                context.lineTo(rotationPointX,rotationPointY);
                context.closePath();
                context.stroke();
                
                lineCounter++;
            
            }
            
            for(var i = 35 ; i <= iPhoneScreenWidth - 35 ; i+=10) {
                
                context.beginPath();
                context.moveTo(i, 100);
                context.lineTo(rotationPointX,rotationPointY);
                context.closePath();
                context.stroke();
                lineCounter++;
            
            }
                        
            context.strokeStyle = "#000";
        }
        
        context.strokeStyle = "#ff0096";
        context.beginPath();
        context.moveTo(rightWall, 300);
        context.lineTo(rotationPointX,rotationPointY);
        context.closePath();
        context.stroke();
        lineCounter++;
        context.strokeStyle = "#000";
        
        
        
                
        context.beginPath();
        context.moveTo(leftWall, 0);
        context.lineTo(leftWall, iPhoneScreenHeight);
        context.closePath();
        context.stroke();
                
        context.beginPath();
        context.moveTo(rightWall, 0);
        context.lineTo(rightWall, iPhoneScreenHeight);
        context.closePath();
        context.stroke();
        
        context.strokeRect(rotationPointX * .75, rotationPointY, rotationPointX * 1.25 - rotationPointX * .75, rotationPointY * .9 - rotationPointY);
                
        event.data.forEach(function(rect) {
            
            context.strokeStyle = "#fff";
            
          if (rect.color === 'custom') {
            rect.color = tracker.customColor;
          }
          
          if( (rect.x > rotationPointX * .75 && rect.x < rotationPointX * 1.25 && rect.y > rotationPointY * .9 && rect.y < rotationPointY) && rect.color != "greenbubble") {
          
                            
              //top left
              context.beginPath();
              context.moveTo(rotationPointX - (rect.width) / 2, rotationPointY - (rect.height) / 2);
              context.lineTo(rect.x,rect.y);
              
              deltaX = rotationPointX - ((rect.width) / 2) - rect.x;
              deltaY = rotationPointY - ((rect.height) / 2) - rect.y;
              
              if(deltaX != 0)
                m = deltaY / deltaX;
              else
                m = .0001;
              
              b = rect.y - m * rect.x;
              
              if(m < 0)
                wall = rightWall;
              else
                wall = leftWall;
              
              
              wallX = wall;
              wallY = m * wall + b;
              
              context.lineTo(wallX, wallY);
              
              wallB = wallY + m * wallX;
                        
              context.lineTo( wallB / m , 0 );          
              context.stroke();
              
              //bottom right
              context.beginPath();
              context.moveTo(rotationPointX + (rect.width) / 2, rotationPointY + (rect.height) / 2);
              context.lineTo(rect.x + rect.width, rect.y + rect.height);          
              
              deltaX = (rotationPointX + (rect.width) / 2) - (rect.x + rect.width);
              deltaY = (rotationPointY + (rect.height) / 2) - (rect.y + rect.height);
              
              if(deltaX != 0)
                m = deltaY / deltaX;
              else
                m = .0001;
              
              b = (rect.y + rect.height) - m * (rect.x + rect.width);
              
              if(m < 0)
                wall = rightWall;
              else
                wall = leftWall;
              
              
              wallX = wall;
              wallY = m * wall + b;
              
              context.lineTo(wallX, wallY);
              
              wallB = wallY + m * wallX;
                        
              context.lineTo( wallB / m , 0 ); 
              context.stroke();
                                      
              //top right
              context.beginPath();
              context.moveTo(rotationPointX + (rect.width) / 2, rotationPointY - (rect.height) / 2);
              context.lineTo(rect.x + rect.width, rect.y);          
              
              deltaX = (rotationPointX + (rect.width) / 2) - (rect.x + rect.width);
              deltaY = (rotationPointY - (rect.height) / 2) - (rect.y);
              
              if(deltaX != 0)
                m = deltaY / deltaX;
              else
                m = .0001;
              
              b = (rect.y) - m * (rect.x + rect.width);
              
              if(m < 0)
                wall = rightWall;
              else
                wall = leftWall;
              
              wallX = wall;
              wallY = m * wall + b;
              
              context.lineTo(wallX, wallY);
              
              wallB = wallY + m * wallX;
                        
              context.lineTo( wallB / m , 0 ); 
              context.stroke();
              
              //bottom left
              context.beginPath();
              context.moveTo(rotationPointX - (rect.width) / 2, rotationPointY + (rect.height) / 2);
              context.lineTo(rect.x,rect.y + rect.height);
              
              deltaX = rotationPointX - ((rect.width) / 2) - rect.x;
              deltaY = (rotationPointY + (rect.height) / 2) - (rect.y + rect.height);
              
              if(deltaX != 0)
                m = deltaY / deltaX;
              else
                deltaX == .0001;
              
              b = (rect.y + rect.height) - m * rect.x;
              
              if(m < 0)
                wall = rightWall;
              else
                wall = leftWall;
              
              
              wallX = wall;
              wallY = m * wall + b;
              
              context.lineTo(wallX, wallY);
              
              wallB = wallY + m * wallX;
                        
              context.lineTo( wallB / m , 0 );          
              context.stroke();
              
          }
          
        });
      });
    };
  </script>

</body>
</html>