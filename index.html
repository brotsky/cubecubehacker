<html>
<head>
<link href="image-picker.css" rel="stylesheet">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="node_modules/tracking/build/tracking-min.js"></script>
<script src="node_modules/dat.gui/build/dat.gui.min.js"></script>

<script src="stats.min.js"></script>

<script type="text/javascript">
    
    var Tesseract = require('tesseract.js');
    var Robot = require('./models/Robot.js');
    var GameEvents = require('./models/GameEvents.js');
    
    const exec = require('child_process').exec;

    var command = "/usr/local/bin/axi up; /usr/local/bin/axi home;";
        
 //   console.log(command);
    /*
    if(!debug)
    exec(command,(error, stdout, stderr) => {
          if (error) {
            console.error(`exec error: ${error}`);
            return;
          }
          console.log(`stdout: ${stdout}`);
          console.log(`stderr: ${stderr}`);
        });
        */

   // exec('say -v Alex "Hello" -r 200');
    
//globals
  
var gridSpacing;
var context;
var showLines = false;

var m, b, deltaX, deltaY, wall, wallX, wallY, wallB, iData;


var device = "iPad" //could be iPhone or iPad

var iPhoneScreenWidth;
var iPhoneScreenHeight;
var iPhoneScreenWidthInches;
var iPhoneScreenHeightInches;
var widthRatio = iPhoneScreenWidthInches / iPhoneScreenWidth;
var heightRatio = iPhoneScreenHeightInches / iPhoneScreenHeight;
var rightWall;
var leftWall;
var rotationPointX;
var rotationPointY; 
var onDeckOffset = 74;

if (device === "iPad") {

gridSpacing = 51;

onDeckOffset = 75;
    
iPhoneScreenWidth = 768;
iPhoneScreenHeight = 1024;

iPhoneScreenWidthInches = 6.67 * 2;
iPhoneScreenHeightInches = 9.4 * 2;

rightWall = (391 / 768) * iPhoneScreenWidth;
leftWall = (30 / 768) * iPhoneScreenWidth;

rotationPointX = (385 / 768) * iPhoneScreenWidth;
rotationPointY = (910 / 1024) * iPhoneScreenHeight; 
    
} else 

if (device === "iPhone") {
gridSpacing = 46.75;
onDeckOffset = 74;
iPhoneScreenWidth = 416 * 1.5;
iPhoneScreenHeight = 738 * 1.5;

iPhoneScreenWidthInches = 2.7 * 2;
iPhoneScreenHeightInches = 4.8 * 2;

rightWall = (391 / 416) * iPhoneScreenWidth;
leftWall = (30 / 416) * iPhoneScreenWidth;

rotationPointX = (208 / 416) * iPhoneScreenWidth;
rotationPointY = (610 / 738) * iPhoneScreenHeight;

}
        


var shooterBallColor, onDeckBallColor;

var bestTouchPointTemp = null;

var bubbleIntersectionRadius = 1.3;

var bubbleColors = ["purple","green","orange","lightblue","blue","red"];

var debug = false;

var displayBubbleColor = 'transparent';

var robotMoving = false;

var readyToShoot = false;



/*

setTimeout(function(){
command = " /usr/local/bin/axi goto " + iPhoneScreenWidthInches + " " + iPhoneScreenHeightInches + ";";
    
console.log(command);

exec(command,(error, stdout, stderr) => {
      if (error) {
        console.error(`exec error: ${error}`);
        return;
      }
      console.log(`stdout: ${stdout}`);
      console.log(`stderr: ${stderr}`);
    });
}, 2000);
*/
</script>

<script src="models/Bubble.js"></script>
<script src="models/Grid.js"></script>
<script src="models/TouchPoint.js"></script>

<script src="helpers/math.js"></script>
<script src="helpers/imageRecognition.js"></script>

<style>
  body {
    background: white;
    display: -webkit-flex;
    -webkit-justify-content: center;
    -webkit-align-items: center;
    -webkit-flex-direction: column;
  }
  video {
    width: 768px;
    height: 1024px;
/*
    width: 1080px;
    height: 1920px;
*/
    background: rgba(0,0,0,0.25);
  }
  button {
    display: inline-block;
    background: -webkit-linear-gradient(#F9F9F9 40%, #E3E3E3 70%);
    background: linear-gradient(#F9F9F9 40%, #E3E3E3 70%);
    border: 1px solid #999;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    padding: 5px 8px;
    outline: none;
    white-space: nowrap;
    -webkit-user-select: none;
    user-select: none;
    cursor: pointer;
    text-shadow: 1px 1px #fff;
    font-weight: 700;
    font-size: 10pt;
  }
  button:hover,
  button.active {
    border-color: black;
  }
  button:active,
  button.active {
    background: -webkit-linear-gradient(#E3E3E3 40%, #F9F9F9 70%);
    background: linear-gradient(#E3E3E3 40%, #F9F9F9 70%);
  }

  video {
    background: white url(desktop.png) center no-repeat;
    border: 1px solid #e2e2e2;
    box-shadow: 0 1px 1px rgba(0,0,0,0.2);
  }
  
  #output-container {
      position: relative;
  }
  
  #grid, .grid-new-piece {
      position: absolute;
        top: 80px;
        left: 24px;
    }

    #grid-new-piece-1 {
        top: 455px;
        left: 10px;
    }
    
    #grid-new-piece-2 {
        top: 455px;
        left: 110px;
    }
    
    #grid-new-piece-3 {
        top: 455px;
        left: 230px;
    }
  
  #grid table td {
        width: 33px;
        height: 35px;
/*       background: rgba(255,0,0,.5); */
  }
  
/*
  #grid table td.empty {
      background: rgba(0,0,0,.5);
  }
  */
  #grid table td.placement {
      background: green;
  }

  
  
  .grid-new-piece table td {
        width: 18px;
        height: 19px;
      background: rgba(255,0,0,.5);
  }
  
  .grid-new-piece table td.empty {
      background: rgba(0,0,0,.5);
  }
  
    video, canvas {
    position: absolute;
  }
  
  #timer {
      z-index: 10000;
  }
  
  #output-container {
      display: none;
  }
  
  #shot-ranking {
      position: fixed;
      top: 100px;
      left: 0;
  }
  
  #shot-ranking ul {
      list-style: none;
  }
  
</style>
</head>
<body>
  <select id="picture" class="image-picker show-html">
  </select>
  <video id="iphone-screen-stream" autoplay></video>
  
  <!-- Uncomment this for iPad: -->
  <canvas id="canvas" width="768" height="1024"></canvas>
  
<!-- Uncomment this for iPhone: -->

<!--   <canvas id="canvas" width="416" height="738"></canvas> -->

  <canvas id="timer" width="50" height="50"></canvas>
  
  <p><button id="enable-capture">Enable Capture</button></p>
  
  <div id="shot-ranking">
      <ul>
      </ul>
  </div>
  
<button onclick="shoot()" style="width: 64px;border: solid 2px #ccc;">Capture</button>
  
  <div id="output-container">
      <div id="output" style="display: inline-block; top: 4px; position: relative ;border: dotted 1px #ccc; padding: 2px;"><img src="demos/1.png"></div>
      <div id="grid"></div>
      <div class="grid-new-piece" id="grid-new-piece-1"></div>
      <div class="grid-new-piece" id="grid-new-piece-2"></div>
      <div class="grid-new-piece" id="grid-new-piece-3"></div>
  </div>
  
  
<script src="app.js"></script>

  <script>
      
    var grid = new Grid;
    
    var w = iPhoneScreenWidth;
                    var h = iPhoneScreenHeight;
                    var videoCanvas = document.createElement('canvas');
                        videoCanvas.width  = w;
                        videoCanvas.height = h;
          
          var videoContext = videoCanvas.getContext('2d');
    
          
    window.onload = function() {
                        
        document.getElementById('iphone-screen-stream').setAttribute("style", "width: " + iPhoneScreenWidth + "px; height: " + iPhoneScreenHeight + "px;");
        document.getElementById('canvas').setAttribute("width", iPhoneScreenWidth);
        document.getElementById('canvas').setAttribute("height", iPhoneScreenHeight);
        
      var canvas = document.getElementById('canvas');
      context = canvas.getContext('2d');
      
      var timerCanvas = document.getElementById("timer");
      
      var video = document.getElementById('iphone-screen-stream');      
      
      context.strokeStyle = "#00901b";
      context.fillStyle = "#fff";
      context.font = '11px Helvetica';
            
      var readScreen = function(delay) {

        videoContext.drawImage(video, 0, 0, w, h);

        var timerContext = videoCanvas.getContext('2d');
            timerContext.drawImage(video,200,400,50,50);
        
        context.clearRect(0, 0, canvas.width, canvas.height);
                
        if(!isPlayingShooter(videoContext)) {
            setTimeout(readScreen,delay);
            return;
        }

        iData = videoContext.getImageData(rotationPointX + onDeckOffset * .2, rotationPointY, 1, 1);
                
        var onDeckData = videoContext.getImageData(rotationPointX, rotationPointY + onDeckOffset, 1, 1);
        
        shooterBallColor = getBubbleColor(iData);
        
        if(shooterBallColor === "lightpurple")
            shooterBallColor = false;
                    
        onDeckBallColor = getBubbleColor(onDeckData);
        
        if(onDeckBallColor === "lightpurple")
            onDeckBallColor = false;
        
        
        var centerX = rotationPointX;
        var centerY = rotationPointY;
        
        var radius = gridSpacing / 2;
        
        context.beginPath();
        context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
        context.lineWidth = 1;
        context.strokeStyle = '#003300';
        context.stroke();
        
        displayBubbleColor = 'transparent';
                                                
        if(bubbleColors.indexOf(shooterBallColor) > -1)
            displayBubbleColor = shooterBallColor;
                                
        context.fillStyle = displayBubbleColor;
        if(shooterBallColor === "lightblue")
            context.fillStyle = "#34a5f2";
        
        context.fill();
        
        context.beginPath();
        context.arc(centerX, centerY + onDeckOffset, radius, 0, 2 * Math.PI, false);
        context.lineWidth = 1;
        context.strokeStyle = '#003300';
        context.stroke();
                
        displayBubbleColor = 'transparent';
                                                
        if(bubbleColors.indexOf(onDeckBallColor) > -1)
            displayBubbleColor = onDeckBallColor;
                                
        context.fillStyle = displayBubbleColor;
        if(onDeckBallColor === "lightblue")
            context.fillStyle = "#34a5f2";
        
        context.fill();        
            
        if(getBubbleColor(iData)) {
            grid.resetGrid();
            for(var j = 0 ; j < 15 ; j++) {
                if(grid.lastRow() == j - 1) //only check until rows are empty
                for(var i = 0 ; i < 11 ; i++) {
                  var centerX;
                  var centerY;
                  if (device === "iPad") {

                    centerX = 120 + i * gridSpacing;
                    centerY = 130 + j * gridSpacing;

                  } else if (device === "iPhone") {

                    centerX = 68 + i * gridSpacing;
                    centerY = 204 + j * gridSpacing;

                  }
                    
                    if(j % 2 === 1)
                        centerX += gridSpacing / 2;
                    
                    var radius = gridSpacing / 2;
                    
                    context.beginPath();
                    context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
                    context.lineWidth = 1;
                    context.strokeStyle = '#003300';
                    context.stroke();
                                                                
                        iData = videoContext.getImageData(Math.round( centerX ),  Math.round( centerY ), 1, 1);
                        
                        //fix bug that only happens on that single bubble                        
                        if(j == 5 && i == 3)
                            iData = videoContext.getImageData(Math.round( centerX),  Math.round( centerY  + .3 * gridSpacing), 1, 1);
                        
                        
                        var bubbleColor = getBubbleColor(iData);
                        
                        displayBubbleColor = 'transparent';
                        
                        
                        if(bubbleColors.indexOf(bubbleColor) > -1)
                            displayBubbleColor = bubbleColor;
                                                
                        
                        
                        var bubble = grid.add(i,j,displayBubbleColor,iData);    
                        
                        if(bubble) {
                            context.fillStyle = displayBubbleColor;
                            if(bubbleColor === "lightblue")
                                context.fillStyle = "#34a5f2";
                            
                            context.fill();
                        } else {
                            context.fillStyle = "#333";
                            
                            context.fill();
                        }        
                }
                
            }
            
            grid.validateGrid();
            
            //create bubbles after validation
            
            var shotRanking = document.getElementById("shot-ranking");
            
            shotRanking.innerHTML = "";
                                    
            var shotRankingHtml = "";
            
            var availableShots = grid.availableShots();
            
            var intersectionCounter = 1;
            for(var i = 0 ; i < availableShots.length ; i++) {
                                
                var shot = availableShots[i];
                
                shotRankingHtml += "<li>"  + intersectionCounter + ": " + shot.points() + "-" + shot.isBlocker() + " pts</li>";
                
                context.beginPath();
                context.arc(shot.getCenterX(), shot.getCenterY(), radius, 0, 2 * Math.PI, false);
                context.fillStyle = 'rgba(0,0,0,.5)';
                
                context.fill();
                context.lineWidth = 1;
                context.strokeStyle = '#003300';
                context.stroke();
                
                if(shot.isBlocker() === true){
                  context.fillStyle = "red";
                }
                else{
                  context.fillStyle = "white";
                }
                context.textAlign = "center";
                context.fillText(intersectionCounter++, shot.getCenterX(), shot.getCenterY()); 
            }           
            
            shotRanking.innerHTML = "<ul>" + shotRankingHtml + "</ul>";
            
            var bubblesLeft = 0;
            
            for(var i = 0 ; i < 5 ; i++) {
                context.beginPath();
                context.arc(140 + i * 39.5, 948 , 16, 0, 2 * Math.PI, false);
                context.strokeStyle = 'rgba(170,170,170,.5)';
                context.stroke();
                
                var upcomingBubble = videoContext.getImageData(140 + i * 39.5, 948 - 8, 1, 1);
        
                var upcomingBubbleColor = getBubbleColor(upcomingBubble);
                                
                if(upcomingBubbleColor === "silver")
                    bubblesLeft++;
            }
                        
            var tempHTML = shotRanking.innerHTML;
            
            tempHTML += "<div style='padding-left: 40px;'><strong>Bubbles Left:</strong> " + bubblesLeft + "</div>";
            
            shotRanking.innerHTML = tempHTML;                        
        }
                
        //draw theoritical lines
        
        if(showLines) {
                        
            context.strokeStyle = "#ff0096";
            
            var lineCounter = 0;
            for(var i = 100 ; i < rotationPointY ; i+=20) {
                
                context.beginPath();
                context.moveTo(leftWall, i);
                context.lineTo(rotationPointX,rotationPointY);
                context.closePath();
                context.stroke();
                lineCounter++;
                
                context.beginPath();
                context.moveTo(rightWall, i);
                context.lineTo(rotationPointX,rotationPointY);
                context.closePath();
                context.stroke();
                
                lineCounter++;
            
            }
            
            for(var i = 35 ; i <= iPhoneScreenWidth - 35 ; i+=10) {
                
                context.beginPath();
                context.moveTo(i, 100);
                context.lineTo(rotationPointX,rotationPointY);
                context.closePath();
                context.stroke();
                lineCounter++;
            
            }
                        
            context.strokeStyle = "#000";
        }
        
        var bestShot = grid.bestShot();                    
        
        if(bestShot) {
            if(typeof bestShot.touchPoints != "undefined" && bestShot.touchPoints.length > 0) {
                
                context.strokeStyle = "#ff0096";
                for(var i = 0 ; i < bestShot.touchPoints.length ; i++) {
                    context.beginPath();
                    context.moveTo(bestShot.touchPoints[i].touchPoint.x, bestShot.touchPoints[i].touchPoint.y);
                    context.lineTo(rotationPointX,rotationPointY);
                    context.closePath();
                    context.stroke();
                }
                
                
                context.strokeStyle = "#000";
            }
        
        
            var bestTouchPoint = bestShot.bestTouchPoint();
            
            if(!shooterBallColor) {
                bestTouchPoint = false;
                bestTouchPointTemp = bestTouchPoint;
            }
            
            
            
            if(bestTouchPoint) {
                if(bestTouchPointTemp == null)
                    bestTouchPointTemp = bestTouchPoint;
                
                if(bestTouchPointTemp.x !== bestTouchPoint.x && bestTouchPointTemp.y !== bestTouchPoint.y) {
                    bestTouchPointTemp = bestTouchPoint;
                    
                    bestTouchPoint.moveRobot();
                }

                if(typeof bestTouchPoint != "undefined") {
                    
                    context.strokeStyle = "#000";
                    
                    context.beginPath();
                    context.moveTo(bestTouchPoint.x, bestTouchPoint.y);
                    context.lineTo(rotationPointX,rotationPointY);
                    context.closePath();
                    context.stroke();
                
                    context.strokeStyle = "#000";
                }
            }
        
        }
        
        
        GameEvents.setConditions({
            "shooterBallColor" : shooterBallColor
        });

        setTimeout(readScreen,0);

      }
      
      readScreen(1);
            
      function stylusPos(event) {
            
            var canvas = document.getElementById("canvas");
            
            var x = event.clientX - canvas.offsetLeft;
            var y = event.clientY - canvas.offsetTop;
            
            console.log("canvasX: " + x +
            " - canvasY: " + y);
            
            console.log(getBubbleColor(videoContext.getImageData(x,y, 1, 1)));
            
            var robot_x = widthRatio * x;
            var robot_y = heightRatio * y;
            
            
            return;
            
            
         //   var command = "/usr/local/bin/axi up; /usr/local/bin/axi goto " + robot_x + " " + robot_y + "; /usr/local/bin/axi down; /usr/local/bin/axi up;";
            
            var command = " /usr/local/bin/axi goto " + robot_x + " " + robot_y + "; ";
            
            console.log(command);
         //   return;
            exec(command,(error, stdout, stderr) => {
                  if (error) {
                    console.error(`exec error: ${error}`);
                    return;
                  }
                  console.log(`stdout: ${stdout}`);
                  console.log(`stderr: ${stderr}`);
                });            
        }
        
        function stylusDown(event) {
                                
            
            var command = "/usr/local/bin/axi down;";
            
            console.log(command);
         //   return;
            exec(command,(error, stdout, stderr) => {
                  if (error) {
                    console.error(`exec error: ${error}`);
                    return;
                  }
                  console.log(`stdout: ${stdout}`);
                  console.log(`stderr: ${stderr}`);
                });            
        }
        
        function stylusUp(event) {
                                
            
            var command = "/usr/local/bin/axi up;";
            
            console.log(command);
         //   return;
            exec(command,(error, stdout, stderr) => {
                  if (error) {
                    console.error(`exec error: ${error}`);
                    return;
                  }
                  console.log(`stdout: ${stdout}`);
                  console.log(`stderr: ${stderr}`);
                });            
        }
        
    //   document.getElementById("canvas").addEventListener("mousemove", stylusPos);
      
    //    document.getElementById("canvas").addEventListener("mousedown",stylusDown);
      //  document.getElementById("canvas").addEventListener("mouseup",stylusUp);
      
      
    };
  </script>
</body>
</html>